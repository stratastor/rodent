http:
  middlewares:
    # API rate limits - less restrictive than auth
    api-rate-limit:
      rateLimit:
        average: 60
        burst: 30
        period: 60s

    # Global rate limit - applied to all IPs across all routes
    global-rate-limit:
      plugin:
        traefik-rate-limit:
          maxDelay: 500ms
          rate: 100
          burst: 50
 
    # Controls which domains can access the API endpoints
    cors-headers:
      headers:
        customResponseHeaders:
          # Configurable origins - accepts domain from environment variable
          Access-Control-Allow-Origin: "https://strata.foo"
          # HTTP methods that are allowed to be used
          Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,OPTIONS"
          # Headers that are allowed to be included in requests
          Access-Control-Allow-Headers: "Origin,Content-Type,Accept,Authorization"
          # Headers that browsers are allowed to access
          Access-Control-Expose-Headers: "Content-Type"
          # Allows authenticated requests (with cookies)
          Access-Control-Allow-Credentials: "true"
          # Browser caches preflight requests for 1 hour (3600 seconds)
          Access-Control-Max-Age: "3600"

    # HTTP to HTTPS redirect middleware
    # Enforces secure connections for all requests
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # Protects against common web vulnerabilities
    security-headers:
      headers:
        customResponseHeaders:
          # HSTS: Forces browsers to use HTTPS for 1 year
          # includeSubDomains ensures all subdomains also use HTTPS
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"
          
          # Prevents browsers from MIME-sniffing
          # Blocks a class of attacks where non-executable MIME types are executed
          X-Content-Type-Options: "nosniff"
          
          # Prevents the site from being embedded in iframes
          # Protects against clickjacking attacks
          X-Frame-Options: "DENY"
          
          # Legacy XSS protection for older browsers
          X-XSS-Protection: "1; mode=block"
          
          # Controls what resources the browser is allowed to load
          # - default-src 'self': Only allow resources from same origin
          # - script-src: Where JavaScript can be loaded from
          # - style-src: Where CSS can be loaded from
          # - img-src: Where images can be loaded from
          # - font-src: Where fonts can be loaded from
          # - connect-src: Restricts URLs for fetch/XHR/WebSocket
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://strata.foo https://*.strata.foo; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://strata.foo https://*.strata.foo; font-src 'self'; connect-src 'self' https://strata.foo https://*.strata.foo; frame-src 'self' https://strata.foo https://*.strata.foo; worker-src 'self' blob:;"

          # strict-origin-when-cross-origin: Full URL for same origin, only domain for cross-origin
          Referrer-Policy: "strict-origin-when-cross-origin"
          
  routers:
    # Handles backend data processing endpoints
    rodent:
      rule: "Host(`*.strata.host`, `strata.host`) && PathPrefix(`/api/v1/rodent`)"
      service: "rodent"
      middlewares:
        - "cors-headers"
        - "api-rate-limit"
      entryPoints:
        - websecure
      tls: "true"

  services:
    # No-operation service for handling redirects
    noop:
      loadBalancer:
        servers:
          - url: "http://localhost"
    
    rodent:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:8042"
